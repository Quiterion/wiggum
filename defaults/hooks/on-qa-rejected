#!/bin/bash
#
# on-qa-rejected - Triggered when QA fails
#
# Pings the worker to address QA comment.
#
# Environment:
#   WIGGUM_TICKET_ID    - The ticket ID
#   WIGGUM_TICKET_PATH  - Full path to ticket file
#   WIGGUM_PREV_STATE   - Previous state (qa)
#   WIGGUM_NEW_STATE    - New state (implement)
#   WIGGUM_AGENT_ID     - Agent that triggered transition (qa agent)
#   WIGGUM_SESSION      - tmux session name
#

TICKET_ID="${1:-$WIGGUM_TICKET_ID}"

echo "[hook] QA rejected for $TICKET_ID"

# Get the assigned worker agent
WORK_AGENT=$(grep 'assigned_agent_id:' "$WIGGUM_TICKET_PATH" | awk '{print $2}')

# Ping the implementer if still running
if [[ -n "$WORK_AGENT" ]]; then
    "${WIGGUM_BIN:-wiggum}" ping "$WORK_AGENT" "Review comment added to your ticket. Please address and re-submit." || true
fi
