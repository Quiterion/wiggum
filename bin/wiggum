#!/bin/bash
# shellcheck disable=SC1091
#
# wiggum - Multi-Agent Orchestration Harness
# Version: 0.1.0
#
# A thin glue between tmux, tickets, hooks, and tools.
# No daemons. No databases. Just shell scripts, markdown files, and Unix philosophy.
#

set -euo pipefail

WIGGUM_VERSION="0.1.0"

# Resolve symlinks to find the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # Handle relative symlinks
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
WIGGUM_ROOT="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"
WIGGUM_LIB="$WIGGUM_ROOT/lib"
export WIGGUM_DEFAULTS="$WIGGUM_ROOT/defaults"

# Exit codes (exported for use in sourced scripts)
export EXIT_SUCCESS=0
export EXIT_ERROR=1
export EXIT_INVALID_ARGS=2
export EXIT_SESSION_NOT_FOUND=3
export EXIT_PANE_NOT_FOUND=4
export EXIT_TICKET_NOT_FOUND=5
export EXIT_INVALID_TRANSITION=6

# Source library functions
source "$WIGGUM_LIB/config.sh"
source "$WIGGUM_LIB/utils.sh"
source "$WIGGUM_LIB/sync.sh"
source "$WIGGUM_LIB/session.sh"
source "$WIGGUM_LIB/pane.sh"
source "$WIGGUM_LIB/ticket.sh"
source "$WIGGUM_LIB/tools.sh"
source "$WIGGUM_LIB/hooks.sh"

# Global flags (set by parse_global_flags, used by utils.sh)
export WIGGUM_QUIET=false
export WIGGUM_VERBOSE=false

usage() {
    cat <<EOF
wiggum - Multi-Agent Orchestration Harness v$WIGGUM_VERSION

Usage: wiggum <command> [options]

Session Management:
  init [--session NAME]         Initialize a new wiggum session
  attach [--session NAME]       Attach to existing session
  teardown [--force]            Tear down session and cleanup

Agent Management:
  spawn <role> [ticket-id]      Spawn an agent in a new pane
  list [--format FORMAT]        List active agents
  kill <agent-id> [--release] [--force] Kill an agent
  ping <agent-id> <message>     Send message to an agent

Observability:
  status [--verbose]            Overview of the hive
  fetch <agent-id> [prompt]     Get summarized agent progress
  digest [prompt]               Summarize the whole hive
  logs <pane-id> [--tail N]     Raw agent trajectory

Ticket Management:
  ticket create <title> [opts]  Create a new ticket
  ticket list [--state STATE]   List tickets
  ticket show <id>              Show ticket details
  ticket ready                  Tickets available for work
  ticket blocked                Tickets waiting on deps
  ticket tree <id>              Dependency tree
  ticket transition <id> <st>   Transition ticket state
  ticket assign <id> <agent>    Assign agent to ticket
  ticket unassign <id>          Remove agent assignment
  ticket edit <id>              Edit ticket in \$EDITOR
  ticket comment <id> <src> <msg>  Add comment
  ticket sync [--pull|--push]   Sync tickets with origin

Global Options:
  --session NAME                Specify tmux session
  --config PATH                 Specify config file
  --quiet                       Suppress non-essential output
  --verbose                     Extra debugging output
  --help                        Show help

Examples:
  wiggum init
  wiggum ticket create "Add auth" --type feature
  wiggum spawn supervisor
  wiggum spawn worker tk-5c46
  wiggum status
EOF
}

parse_global_flags() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
        --session)
            export WIGGUM_SESSION="$2"
            shift 2
            ;;
        --config)
            export WIGGUM_CONFIG_PATH="$2"
            shift 2
            ;;
        --quiet)
            WIGGUM_QUIET=true
            shift
            ;;
        --verbose)
            WIGGUM_VERBOSE=true
            shift
            ;;
        --help | -h)
            usage
            exit 0
            ;;
        --version | -v)
            echo "wiggum v$WIGGUM_VERSION"
            exit 0
            ;;
        *)
            # Return remaining args
            REMAINING_ARGS=("$@")
            return 0
            ;;
        esac
    done
    REMAINING_ARGS=()
}

main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit $EXIT_INVALID_ARGS
    fi

    # Parse global flags first
    parse_global_flags "$@"
    set -- "${REMAINING_ARGS[@]:-}"

    if [[ $# -eq 0 ]]; then
        usage
        exit $EXIT_INVALID_ARGS
    fi

    local cmd="$1"
    shift

    case "$cmd" in
    # Session management
    init)
        cmd_init "$@"
        ;;
    attach)
        cmd_attach "$@"
        ;;
    teardown)
        cmd_teardown "$@"
        ;;

    # Pane management
    spawn)
        cmd_spawn "$@"
        ;;
    list)
        cmd_list "$@"
        ;;
    kill)
        cmd_kill "$@"
        ;;
    ping)
        cmd_ping "$@"
        ;;

    # Observability
    status)
        cmd_status "$@"
        ;;
    fetch)
        cmd_fetch "$@"
        ;;
    digest)
        cmd_digest "$@"
        ;;
    logs)
        cmd_logs "$@"
        ;;

    # Ticket subcommands
    ticket)
        cmd_ticket "$@"
        ;;

    # Hook subcommands
    hook)
        cmd_hook "$@"
        ;;

    # Utilities
    has-capacity)
        cmd_has_capacity "$@"
        ;;

    # Internal
    --ephemeral)
        cmd_ephemeral "$@"
        ;;

    help | --help | -h)
        usage
        ;;

    *)
        error "Unknown command: $cmd"
        usage
        exit $EXIT_INVALID_ARGS
        ;;
    esac
}

main "$@"
